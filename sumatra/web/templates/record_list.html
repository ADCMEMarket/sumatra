{% extends "base.html" %}

{% load filters %}

{% block title %}{{project_name}}: List of records{% endblock %}

{% block header %}
            <li class="divider"></li>
            <li><a href="/{{project_name}}/">{{project_name}}</a></li>
            <li><a href="/{{project_name}}/data/">
                Switch to Data view</a></li> 
{% endblock %}


{% block content %} 

<br/>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css"
      href="/media/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css"
      href="/media/css/dataTables.colVis.css">

<!-- jQuery -->
<script type="text/javascript" chadatrset="utf8" src="/media/js/jquery.js"></script>

<!-- DataTables -->
<script type="text/javascript" charset="utf8"
        src="/media/js/jquery.dataTables.js"></script>
<script type="text/javascript" charset="utf8"
        src="/media/js/dataTables.colVis.js"></script>




<div style="display:none">


    "columns": [
      {"sortable": false}, <!-- repository -->
      {"sortable": false}, <!-- label -->
      {"sortable": false}, <!-- tag -->
      {"sortable": false}, <!-- reason -->
      {"sortable": false}, <!-- outcome -->
      {"sortable": false}, <!-- duration -->
      null, <!-- processes -->
      null, <!-- time -->
      null, <!-- exec. -->
      {"sortable:" false}, <!-- main -->
      {"sortable": false} <!-- version -->
      ],   

</div>

<script>
  $(document).ready( function () {

  var hd_cl = {{settings.record_hidden_cols|as_json|safe}};
  var record_list = $('#record_dt').DataTable({
    "columnDefs": [
      {"sortable":false,  "targets":["repository-c", "label-c",
       "tag-c", "reason-c", "outcome-c", "main-c", "version-c"]},   
      {"visible":false, "targets": hd_cl},
    ],
    <!--"dom": 'lfrC<"clear">tip',     <!-- Order: 'l'ength, 'f'ilter,  p'r'ocessing, 'C'olumns, 't'able, 'i'nformation, 'p'agination -->
    "paging": true,
    "ordering": true,
    "info": true, <!-- "Showing x of y entries" -->
    "filter": true, 
    "lengthChange": false,
    "order": [[$('th.time-c').index(), "desc"]], <!-- default sort column -->
    } );



    <!-- Column visibility toggle -->
    $('input.check-item').on( 'change', function (e) {
        e.preventDefault();

        // Get the column API object
        var column = record_list.column($(this).attr('data-column')
        );

        console.log($(this).attr('data-column'))
 
        // Toggle the visibility
        column.visible( ! column.visible() );

        <!--console.log($.get("/{{project_name}}/settings"))-->

        // save settings to .smtrc
        // $.post("/{{project_name}}/settings", {'record_hidden_cols':['murloc'],'saveSettings':true}); 
    } );

    // Save changes button   
    $('#save_set').click(function(){  
        record_list.page.len($('#s_nbt').val());
        record_list.draw();
        });



  <!-- Arrow key page turning -->
  document.onkeydown = checkKey;
  function checkKey(e) {

      e = e || window.event;

      if (e.keyCode == '37') {
          record_list.page('previous').draw(false);
      }
      else if (e.keyCode == '39') {
          record_list.page('next').draw(false);
      }
  }

    } );

</script>


<!--    "repository", "label",
    "tag", 
    "reason", 
    "outcome", 
    "duration", 
    "processes", 
    "ename", 
    "eversion", 
    "date", 
    "time", 
    "main", 
    "version", 
    "arguments" -->




<div id = 'tab_general_content'>
  <label class="checkbox">
    <input type="checkbox" id='repository' class='check-item' 
           data-column='0'>
           Repository
  </label>
  <label class="checkbox">
    <input type="checkbox" id='label' class='check-item' data-column='1'>
    Label
  </label>
  <label class="checkbox">
    <input type="checkbox" id='tag' class='check-item' data-column='2'>
    Tag
  </label>
  <label class="checkbox">
    <input type="checkbox" id='reason' class='check-item' data-column='3'>
    Reason
  </label>
  <label class="checkbox">
    <input type="checkbox" id='outcome' class='check-item' data-column='4'> Outcome
  </label>
  <label class="checkbox">
    <input type="checkbox" id='duration' class='check-item' data-column='5'> Duration
  </label>
  <label class="checkbox">
    <input type="checkbox" id='processes' class='check-item' data-column='6'>
           Processes
  </label>
  <label class="checkbox">
    <input type="checkbox" id='time' class='check-item' data-column='7'>
    Time
  </label>
  <label class="checkbox">
    <input type="checkbox" id='ename' class='check-item' data-column='8'>
    Executable
  </label>

  <label class="checkbox">
    <input type="checkbox" id='main' class='check-item' data-column='9'>
    Script main file
  </label>
  <label class="checkbox">
    <input type="checkbox" id='version' class='check-item'
           data-column='10'> 
    Script version
  </label>
  <label class="checkbox">
    <input type="checkbox" id='arguments' class='check-item' data-column='11'> Script
           arguments
  </label>
  <label class="checkbox">
    <input type="checkbox" id = 'selectAll'
           checked="checked"><b style='font-size:14px'>Select all</b>
  </label>
  <div style='float:left; padding:8px; padding-left:0px'>Number of
       records per page:</div>
  <input id='s_nbt' class='span1' type='text' style='float:left;margin-bottom:0px' value='{{settings.nb_records_per_page}}'>
</div>
</div>
<div class="modal-footer">
  <a class="btn" data-dismiss="modal">Close</a>
  <a class="btn btn-primary" id='save_set'>Save changes</a>
</div>

<!-- <script type = 'text/javascript'>
$(document).ready(function(){ 
    // click on the compact/comfortable anchor tag in settings drop-down list
    $('.menu-rsettings').not('#button_settings').click(function(){
        var $density_set = $(this).attr('id');      //compact or comfortable
        $('.menu-rsettings').removeClass('active');
        $(this).addClass('active');
        // save into ~/.smtrc file the changed 'table density' settings
        $.post("/{{project_name}}/settings", {'display_density':$density_set,'saveSettings':true}); 
        // change the style of the table 
        if ($density_set == 'compact'){
            $('.record').removeClass('comfortable').addClass('condensed');
        }else{
            $('.record').removeClass('condensed').addClass('comfortable');
        }  
    });

    // user opens settings_window
    $('#button_settings').on('click', function(){
        $('#default_header').css('display', 'inline');
        $('.check-item').attr('checked', false); // uncheck all of them
        // in the settings form refresh the current state of chkboxes:
        $('#default_header label').not(':hidden').each(function(){
            var str_chbx = ['.check-item#', $(this).attr('id').split('-')[1]].join('');
            $(str_chbx).attr('checked', true);
        });
    });

    $('.check-item, #button_settings').on('click', function(){
        var $btext = $('#selectAll').parent().find('b');
        var nbChecked = $(".check-item:checked").length;
        if ($(".check-item").length > nbChecked) { //if there are some unchecked 
            $btext.html('Select all');  // change text
            $("#selectAll").attr('checked', false);
        }else{
            $btext.html('Deselect all');
            $("#selectAll").attr('checked', true);
        }
        if (nbChecked) {
            $('#save_set').removeClass('disabled');
        }else{
            $('#save_set').addClass('disabled');
        }
    });
    
    // settings_window: user clicks 'select all' checkbox
    $("#selectAll").click(function() { 
        var checkedStatus = this.checked; // true or false
        var $btext = $('#selectAll').parent().find('b');       
        $(".check-item").each(function() {
            this.checked = checkedStatus;
        });          
        if (checkedStatus){ $btext.html('Deselect all'); $('#save_set').removeClass('disabled');}
        else {$btext.html('Select all'); $('#save_set').addClass('disabled');} 
    });

    // settings_window: user click 'save'
    $('#save_set').click(function(){    
        if (!$('#save_set').hasClass('disabled')){ 
            //var str_rec, str_head,  
            var uncheckedItems = new Array(); // all unchecked chkboxes
            var nb_rec = $('#s_nbt').val(); // number of records per one page
            if (parseInt(nb_rec) > 0){
                // hide columns:
                $("#setModal .check-item").not(':checked').each(function() { 
                    var $unchecked = $(this).attr('id');
                    //str_rec = ['.record #', $unchecked, '-t'].join(''); // records selector string
                    //str_head = ['#l-', $unchecked].join(''); // header of the table selector string           
                    uncheckedItems.push($unchecked);
                }); 
                // save settings to ~/.smtrc
                $('#innerContent').load('settings',{'hidden_cols':uncheckedItems, 
                                                    'nb_records_per_page':nb_rec}, showjGrowl());
            }          
            else{
                alert('Please enter the vaid number of records')
            }
        }  
    });
});
</script>-->






<br />






<div style="margin-left:2%; margin-right:3%">
<table class='hover row-border' id='record_dt'>

  <thead>
    <tr>
      <th class='repository-c'>repository</th>
      <th class='label-c'>label</th>
      <th class='tag-c'>tag</th>
      <th class='reason-c'>reason</th>
      <th class='outcome-c'>outcome</th>
      <th class='duration-c'>duration</th>
      <th class='processes-c'>processes</th>
      <th class='time-c'>time</th>
      <th class='exec-c'>exec.</th>
      <th class='main-c'>main</th>
      <th class='version-c'>version</th>
      <th class='arguments-c'>arguments</th>
    </tr>
  </thead>

  <tbody>

    {% for record in sim_list %}

    <tr>     
      <!--<td class='dataTable_td'  id = 'version-hid' class='d-hid'>                     {{record.version}}
          </td>
      <td class='dataTable_td'  id = 'repo-hid' class='d-hid'>
        {{record.repository.url}}
      </td> 
      to be hidden. what do they do?
      -->
      
      <td class='dataTable_td' id='repository-t'>
        <span class="span-box">
          {{record.repository.url|cut:"repo"}}
        </span>
      </td>
      <td class='dataTable_td' id='label-t'>
        <a href="/{{project_name}}/{{record.label}}/">
          {{record.label|ubreak}}
        </a> 
        
      </td> 
      {% if tag %}
      <td class='dataTable_td' id='tag-t'>
        {% for other_tag in record.tag_objects %}
        {% if tag == other_tag %}
        {{tag}} 
        {% else %}
        <a href="#">
          {{other_tag.name}}
        </a> <!-- Fix Link!! -->
        {% endif %}
        {% endfor %}
      </td>
      {% else %}
      <td class='dataTable_td' id='tag-t'>
        {% for tag in record.tag_objects %}
        <a href="#">{{tag}}</a>, <!-- Fix Link!! -->
        {% endfor %}
      </td> 
      {% endif %}

      <td class='dataTable_td' id='reason-t'>
        {{record.reason}}
      </td>
      <td class='dataTable_td' id='outcome-t'>
        {{record.outcome}}
      </td>
      <td class='dataTable_td' id='duration-t'
          data-sort='{{record.duration}}'>
        {{record.duration|human_readable_duration}}
      </td>
      <td class='dataTable_td' id='processes-t'>
        {{record.launch_mode.get_parameters.n|default:"1"}}
      </td>
      <td class='dataTable_td' id='time-t'>
        <span style='display:none;'>
          <!-- hack for correct sorting -->
          {{record.timestamp|date:"YmdHis"}}
        </span>
        {{record.timestamp|date:"d/m/Y H:i:s"}}
      </td>
      <td class='dataTable_td' id='ename-t'>
        {{record.executable.name}} {{record.executable.version}}
      </td>
      <td class='dataTable_td' id='main-t'>
        <a class='id-script'  data-toggle="modal" href="#">
          {{record.main_file|ubreak}}
        </a> <!-- Fix Link!! -->
      </td>
      <td class='dataTable_td' id='version-t'>
        <span class="span-box">
          {{record.version|cut:"vers"}}
          {% if record.diff %}
          *
          {% endif %}
        </span>
      </td>
      <td class='dataTable_td' id='arguments-t'>
        <a class='href_args' href='#'>
          {{record.script_arguments}}
        </a> <!-- Fix Link!! -->
      </td> 
    </tr>
    {% endfor %}
  <tbody>
</table>
</div>

 

{% endblock %}

